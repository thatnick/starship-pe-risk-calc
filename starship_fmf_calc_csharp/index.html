<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Preeclampsia Risk Calculator</title>
    <script>
      async function calculateRisk() {
        const formData = new FormData(
          document.getElementById("predictionForm")
        );

        const priorForm = {
          Age: parseFloat(formData.get("age")),
          Weight: parseFloat(formData.get("weight")),
          Height: parseFloat(formData.get("height")),
          Ethnicity: formData.get("ethnicity"),
          FamilyHistoryPE: formData.get("fam-hist-pe") === "yes",
          IVF: formData.get("conception") === "ivf",
          ChronicHypert: formData.get("chronic-hypert") === "yes",
          Diabetes: formData.get("diabetes") === "yes",
          Autoimmune: formData.get("autoimmune") === "yes",
          PregnancyInterval: parseFloat(formData.get("preg-interval")) || 0,
          PrevGestAge: parseFloat(formData.get("prev-gest-age")) || 0,
        };

        const momValues = {
          MapMoM: parseFloat(formData.get("map")),
          UtaPiMoM: parseFloat(formData.get("uta-pi")),
          PlgfMoM: parseFloat(formData.get("plgf")),
        };

        try {
          console.log("Body: ", { priorForm, momValues });
          const response = await fetch("http://localhost:5128/calculate-risk", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ priorForm, momValues }),
          });

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const result = await response.json();
          console.log("Server response:", result); // Log the server response

          if (result.riskPrior !== undefined && result.riskPost !== undefined) {
            let oddsPrior = 1 / result.riskPrior;
            let oddsPost = 1 / result.riskPost;
            oddsPrior = oddsPrior > 10000 ? 10000 : oddsPrior;
            oddsPost = oddsPost > 10000 ? 10000 : oddsPost;
            document.getElementById(
              "resultPrior"
            ).textContent = `Preeclampsia risk from history only at < 37 weeks: 1 in ${Math.round(oddsPrior)}`;
            document.getElementById(
              "resultPost"
            ).textContent = `Preeclampsia risk from history plus biomarkers at < 37 weeks: 1 in ${Math.round(oddsPost)}`;
          } else {
            document.getElementById(
              "result"
            ).textContent = `Error: Risk value is undefined in the response.`;
          }
        } catch (error) {
          console.error("There was an error with the request:", error);
          document.getElementById(
            "result"
          ).textContent = `Error calculating risk: ${error.message}`;
        }
      }
    </script>
  </head>
  <body>
    <h2>Preeclampsia Prediction Form</h2>
    <form id="predictionForm">
      <label for="age"
        >Maternal Age at Estimated Date of Delivery (years):</label
      >
      <input
        type="number"
        id="age"
        name="age"
        value="25"
        required
      /><br /><br />

      <label for="weight"
        >Maternal Weight at the First Trimester Visit (kg):</label
      >
      <input
        type="number"
        id="weight"
        name="weight"
        value="69"
        required
      /><br /><br />

      <label for="height">Maternal Height (cm):</label>
      <input
        type="number"
        id="height"
        name="height"
        value="164"
        required
      /><br /><br />

      <label for="ethnicity">Maternal Racial Origin:</label>
      <select id="ethnicity" name="ethnicity" required>
        <option value="white" selected>White</option>
        <option value="black">Black</option>
        <option value="south-asian">South Asian</option>
        <option value="east-asian">East Asian</option></select
      ><br /><br />

      <label for="parity">Previous Obstetric History:</label>
      <select id="parity" name="parity" required>
        <option value="nulliparous" selected>Nulliparous</option>
        <option value="parous-no-pe">Parous without previous PE</option>
        <option value="parous-with-pe">Parous with previous PE</option></select
      ><br /><br />

      <label for="preg-interval">Previous Pregnancy Interval (years):</label>
      <input
        type="number"
        step="0.01"
        id="preg-interval"
        name="preg-interval"
        value=""
      /><br /><br />

      <label for="prev-gest-age"
        >Gestational Age at Delivery of Previous Pregnancy (weeks):</label
      >
      <input
        type="number"
        step="0.01"
        id="prev-gest-age"
        name="prev-gest-age"
        value=""
      /><br /><br />

      <label for="fam-hist-pe">Family History of PE (Mother):</label>
      <select id="fam-hist-pe" name="fam-hist-pe" required>
        <option value="no" selected>No</option>
        <option value="yes">Yes</option></select
      ><br /><br />

      <label for="conception">Method of Conception:</label>
      <select id="conception" name="conception" required>
        <option value="natural" selected>Natural</option>
        <option value="ivf">IVF</option>
        <option value="ovulation-drugs">Ovulation Drugs</option></select
      ><br /><br />

      <label for="chronic-hypert">History of Chronic Hypertension:</label>
      <select id="chronic-hypert" name="chronic-hypert" required>
        <option value="no" selected>No</option>
        <option value="yes">Yes</option></select
      ><br /><br />

      <label for="diabetes">History of Diabetes Mellitus:</label>
      <select id="diabetes" name="diabetes" required>
        <option value="no" selected>No</option>
        <option value="yes">Yes</option></select
      ><br /><br />

      <label for="autoimmune"
        >History of Systemic Lupus Erythematosus or Antiphospholipid
        Syndrome:</label
      >
      <select id="autoimmune" name="autoimmune" required>
        <option value="no" selected>No</option>
        <option value="yes">Yes</option></select
      ><br /><br />

      <h3>MoM Values</h3>
      <label for="map">MAP:</label>
      <input
        type="number"
        step="0.01"
        id="map"
        name="map"
        value="0.807"
      /><br /><br />

      <label for="uta-pi">UtA-PI:</label>
      <input
        type="number"
        step="0.01"
        id="uta-pi"
        name="uta-pi"
        value="0.872"
      /><br /><br />

      <label for="plgf">PlGF:</label>
      <input
        type="number"
        step="0.01"
        id="plgf"
        name="plgf"
        value="1"
      /><br /><br />

      <button type="button" onclick="calculateRisk()">Calculate Risk</button>
    </form>
    <p id="resultPrior"></p>
    <p id="resultPost"></p>
  </body>
</html>
