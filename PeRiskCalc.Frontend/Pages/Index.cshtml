@page
@model IndexModel
@{
    ViewData["Title"] = "Calculator";
}

@section scripts {
    <script>
        async function calculateRisk() {
            const formData = new FormData(
                document.getElementById("calculator-form")
            );

            const pregnancy = {

            }

            const characteristics = {
                Age: parseFloat(formData.get("age")),
                Weight: parseFloat(formData.get("weight")),
                Height: parseFloat(formData.get("height")),
                Ethnicity: formData.get("ethnicity"),
                FamilyHistoryPE: formData.get("fam-hist-pe") === "yes",
                IVF: formData.get("conception") === "ivf",
                ChronicHypert: formData.get("chronic-hypert") === "yes",
                Diabetes: formData.get("diabetes") === "yes",
                Autoimmune: formData.get("autoimmune") === "yes",
                PregnancyInterval: parseFloat(formData.get("preg-interval")) || 0,
                PrevGestAge: parseFloat(formData.get("prev-gest-age")) || 0,
            };

            const history = {

            }



            const measurements = {
                MapMoM: parseFloat(formData.get("map")),
                UtaPiMoM: parseFloat(formData.get("uta-pi")),
                PlgfMoM: parseFloat(formData.get("plgf")),
            };

            try {

                const response = await fetch("http://localhost:5128/calculate-risk", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ pregnancy, characteristics, history, measurements }),
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();


                if (result.riskPrior !== undefined && result.riskPost !== undefined) {
                    let oddsPrior = 1 / result.riskPrior;
                    let oddsPost = 1 / result.riskPost;
                    oddsPrior = oddsPrior > 10000 ? 10000 : oddsPrior;
                    oddsPost = oddsPost > 10000 ? 10000 : oddsPost;
                    document.getElementById(
                        "resultPrior"
                    ).textContent = `Preeclampsia risk from history only at < 37 weeks: 1 in ${Math.round(oddsPrior)}`;
                    document.getElementById(
                        "resultPost"
                    ).textContent = `Preeclampsia risk from history plus biomarkers at < 37 weeks: 1 in ${Math.round(oddsPost)}`;
                } else {
                    document.getElementById(
                        "result"
                    ).textContent = `Error: Risk value is undefined in the response.`;
                }
            } catch (error) {
                console.error("There was an error with the request:", error);
                document.getElementById(
                    "result"
                ).textContent = `Error calculating risk: ${error.message}`;
            }
        }
    </script>
}

<div class="container mt-5">
    <form id="calculator-form" class="needs-validation" novalidate>
        <!-- PREGNANCY DETAILS -->
        <div class="border p-3 mb-4">
            <h5 class="mb-3">Pregnancy details</h5>
            <div class="row mb-3">
                <label for="pregnancyType" class="col-sm-4 col-form-label">Singleton or twins</label>
                <div class="col-sm-2">
                    <select id="pregnancyType" name="pregnancyType" class="form-select">
                        <!-- Options here -->
                    </select>
                </div>
            </div>

            <div class="row mb-3">
                <label for="fetalCrownRumpLength" class="col-sm-4 col-form-label">Fetal crown-rump length</label>
                <div class="col-sm-2">
                    <div class="input-group">

                        <input type="number" id="fetalCrownRumpLength" name="fetalCrownRumpLength"
                            class="form-control" />
                        <span class="input-group-text">mm</span>
                    </div>
                </div>

            </div>
            <div class="row mb-3">
                <p class="col-sm-4">Gestational age</p>
                <div class="col-sm-4">
                    <p><span>x</span> weeks</p>
                </div>

            </div>

        </div>
        <!-- MATERNAL CHARACTERISTICS -->
        <div class="border p-3 mb-4">
            <h5 class="mb-3">Maternal characteristics</h5>
            <div class="row mb-3">
                <label for="dateOfBirth" class="col-sm-4 col-form-label">Date of birth</label>
                <div class="col-sm-2">
                    <input type="date" id="dateOfBirth" name="dateOfBirth" class="form-control" />
                </div>
            </div>
            <div class="row mb-3">
                <label for="height" class="col-sm-4 col-form-label">Height</label>
                <div class="col-sm-2">
                    <input type="number" id="height" name="height" class="form-control" placeholder="cm" />
                </div>
            </div>
            <div class="row mb-3">
                <label for="weight" class="col-sm-4 col-form-label">Weight</label>
                <div class="col-sm-2">
                    <input type="number" id="weight" name="weight" class="form-control" placeholder="kg" />
                </div>

            </div>
            <div class="row mb-3">
                <label for="ethnicity" class="col-sm-4 col-form-label">Ethnicity</label>
                <div class="col-sm-2">
                    <select id="ethnicity" name="ethnicity" class="form-select">
                        <!-- Options here -->
                    </select>
                </div>
            </div>
            <div class="row mb-3">
                <label for="smoking" class="col-sm-4 col-form-label">Smoking during pregnancy</label>
                <div class="col-sm-8">
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="radio" name="smoking" id="smokingYes" value="yes">
                        <label class="form-check-label" for="smokingYes">Yes</label>
                    </div>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="radio" name="smoking" id="smokingNo" value="no" checked>
                        <label class="form-check-label" for="smokingNo">No</label>
                    </div>
                </div>
            </div>
            <div class="row mb-3">
                <label for="famHistPE" class="col-sm-4 col-form-label">Mother of the patient had PE</label>
                <div class="col-sm-8">
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="radio" name="famHistPE" id="famHistPEYes" value="yes">
                        <label class="form-check-label" for="famHistPEYes">Yes</label>
                    </div>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="radio" name="famHistPE" id="famHistPENo" value="no"
                            checked>
                        <label class="form-check-label" for="famHistPENo">No</label>
                    </div>
                </div>
            </div>
            <div class="row mb-3">
                <label for="conceptionMethod" class="col-sm-4 col-form-label">Conception method</label>
                <div class="col-sm-2">
                    <select id="conceptionMethod" name="conceptionMethod" class="form-select">
                        <!-- Options here -->
                    </select>
                </div>
            </div>
        </div>
        <!-- MEDICAL HISTORY -->
        <div class="border p-3 mb-4">
            <h5 class="mb-3">Medical history</h5>
            <div class="row mb-3">
                <label for="chronicHypert" class="col-sm-6 col-form-label">Chronic hypertension</label>
                <div class="col-sm-6">
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="radio" name="chronicHypert" id="chronicHypertYes"
                            value="yes">
                        <label class="form-check-label" for="chronicHypertYes">Yes</label>
                    </div>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="radio" name="chronicHypert" id="chronicHypertNo"
                            value="no" checked>
                        <label class="form-check-label" for="chronicHypertNo">No</label>
                    </div>
                </div>
            </div>
            <div class="row mb-3">
                <label for="diabetes" class="col-sm-6 col-form-label">Diabetes (type I or II)</label>
                <div class="col-sm-6">
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="radio" name="diabetes" id="diabetesYes" value="yes">
                        <label class="form-check-label" for="diabetesYes">Yes</label>
                    </div>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="radio" name="diabetes" id="diabetesNo" value="no" checked>
                        <label class="form-check-label" for="diabetesNo">No</label>
                    </div>
                </div>
            </div>
            <div class="row mb-3">
                <label for="slea" class="col-sm-6 col-form-label">Systemic lupus erythematosus</label>
                <div class="col-sm-6">
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="radio" name="slea" id="sleaYes" value="yes">
                        <label class="form-check-label" for="sleaYes">Yes</label>
                    </div>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="radio" name="slea" id="sleaNo" value="no" checked>
                        <label class="form-check-label" for="sleaNo">No</label>
                    </div>
                </div>
            </div>
            <div class="row mb-3">
                <label for="aps" class="col-sm-6 col-form-label">Anti-phospholipid syndrome</label>
                <div class="col-sm-6">
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="radio" name="aps" id="apsYes" value="yes">
                        <label class="form-check-label" for="apsYes">Yes</label>
                    </div>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="radio" name="aps" id="apsNo" value="no" checked>
                        <label class="form-check-label" for="apsNo">No</label>
                    </div>
                </div>
            </div>
        </div>
<!-- OBSTETRIC HISTORY -->
        <div class="border p-3 mb-4">
            <h5 class="mb-3">Obstetric history</h5>
            <div class="row mb-3">
                <label for="parity" class="col-sm-6 col-form-label">Nulliparous (no previous pregnancies at ≥24
                    weeks)</label>
                <div class="col-sm-6">
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="radio" name="parity" id="parityNulliparous"
                            value="nulliparous" checked>
                        <label class="form-check-label" for="parityNulliparous">Nulliparous</label>
                    </div>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="radio" name="parity" id="parityParous"
                            value="parous-no-pe">
                        <label class="form-check-label" for="parityParous">Parous without previous PE</label>
                    </div>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="radio" name="parity" id="parityParousPE"
                            value="parous-with-pe">
                        <label class="form-check-label" for="parityParousPE">Parous with previous PE</label>
                    </div>
                </div>
            </div>
        </div>
<!-- BIO-MEASUREMENTS -->
        <div class="border p-3 mb-4">
            <h5 class="mb-3">Bio-measurements</h5>
            <div class="row mb-3">
                <label for="map" class="col-sm-6 col-form-label">Mean arterial pressure (MAP)</label>
                <div class="col-sm-4">
                    <input type="number" step="0.01" id="map" name="map" class="form-control" />
                </div>
                <div class="col-sm-2">
                    <span class="input-group-text">mmHg</span>
                </div>
            </div>
            <div class="row mb-3">
                <label for="uta-pi" class="col-sm-6 col-form-label">Mean uterine artery PI</label>
                <div class="col-sm-4">
                    <input type="number" step="0.01" id="uta-pi" name="uta-pi" class="form-control" />
                </div>
                <div class="col-sm-2">
                    <span class="input-group-text">PI</span>
                </div>
            </div>
            <div class="row mb-3">
                <label for="plgf" class="col-sm-6 col-form-label">Serum PLGF</label>
                <div class="col-sm-6">
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="radio" name="plgf" id="plgfNo" value="no" checked>
                        <label class="form-check-label" for="plgfNo">Not available</label>
                    </div>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="radio" name="plgf" id="plgfMoM" value="mom">
                        <label class="form-check-label" for="plgfMoM">MoM</label>
                    </div>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="radio" name="plgf" id="plgfRaw" value="raw">
                        <label class="form-check-label" for="plgfRaw">Raw data</label>
                    </div>
                </div>
            </div>
        </div>

        <div class="text-center">
            <button type="button" class="btn btn-primary" onclick="calculateRisk()">Calculate Risk</button>
        </div>
    </form>
    <div class="mt-4">
        <p id="resultPrior" class="text-center"></p>
        <p id="resultPost" class="text-center"></p>
    </div>
</div>
